consolo_production=# select * from (
SELECT * FROM (SELECT dbid, rank() OVER ( ORDER BY calls DESC) rank_calls, ---
round( CAST((total_time/calls)/1000 AS NUMERIC),3) avg_seconds, calls, round(total_time/1000) total_seconds, 
rank() OVER ( ORDER BY total_time DESC) rank_total_seconds ,
rank() OVER ( ORDER BY total_time/calls DESC) rank_avg_seconds, ROWS, 
substr(QUERY,1,400) AS "query (truncated)"
--query
FROM pg_stat_statements t1 -- pg_stat_statements t1 
WHERE QUERY <> 'COMMIT' AND QUERY NOT LIKE 'SET application_name%' AND QUERY NOT LIKE 'COPY%'AND QUERY NOT LIKE 'CREATE%' AND QUERY NOT LIKE 'ALTER%' and QUERY <> 'BEGIN' and QUERY <> 'SELECT ?' 
and query like '%roles_users%'
--and dbid not in (1073152)
) t1 
--WHERE avg_seconds > .01 
ORDER BY rank_calls ASC
) t 
;
 dbid  | rank_calls | avg_seconds |   calls   | total_seconds | rank_total_seconds | rank_avg_seconds |    rows     |                                                                                                                                                                                                query (truncated)                                                                                                                                                                                                 
-------+------------+-------------+-----------+---------------+--------------------+------------------+-------------+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 16563 |          1 |       0.001 | 420839135 |        247704 |                  1 |               13 |   249051231 | SELECT  $1 AS one FROM "role_grants" INNER JOIN roles_users ON role_grants.role_id = roles_users.role_id WHERE "role_grants"."agency_id" = $2 AND (roles_users.user_id = $3 AND role_grants.action = $4 AND role_grants.category = $5) LIMIT $6
 16563 |          2 |       0.000 | 131120028 |         43953 |                  4 |               16 |   254344076 | SELECT "roles"."name" FROM "roles" INNER JOIN "roles_users" ON "roles"."id" = "roles_users"."role_id" WHERE "roles"."agency_id" = $1 AND "roles_users"."user_id" = $2 AND (roles.agency_id IN ($3))
 16563 |          3 |       0.000 |  79025696 |         30698 |                  5 |               14 |   159680863 | SELECT "roles".* FROM "roles" INNER JOIN "roles_users" ON "roles"."id" = "roles_users"."role_id" WHERE "roles"."agency_id" = $1 AND "roles_users"."user_id" = $2 AND (roles.agency_id IN ($3))
 16563 |          4 |       0.003 |  21453599 |         64306 |                  3 |                8 | 15004672083 | SELECT "role_grants".* FROM "role_grants" INNER JOIN "roles" ON "role_grants"."role_id" = "roles"."id" INNER JOIN "roles_users" ON "roles"."id" = "roles_users"."role_id" WHERE "role_grants"."agency_id" = $1 AND "roles"."agency_id" = $2 AND "roles_users"."user_id" = $3 AND (roles.agency_id IN ($4))
 16563 |          5 |       0.000 |  16653655 |           596 |                  8 |               18 |     5827417 | SELECT  $1 AS one FROM "roles" INNER JOIN "roles_users" ON "roles"."id" = "roles_users"."role_id" WHERE "roles"."agency_id" = $2 AND "roles_users"."user_id" = $3 AND (roles.agency_id IN ($4)) AND "roles"."id" = $5 LIMIT $6
 16563 |          6 |       0.000 |   7764881 |          2947 |                  7 |               15 |    16102903 | SELECT "roles".id FROM "roles" INNER JOIN "roles_users" ON "roles"."id" = "roles_users"."role_id" WHERE "roles"."agency_id" = $1 AND "roles_users"."user_id" = $2 AND (roles.agency_id IN ($3))
 16563 |          7 |       0.010 |   6846886 |         70074 |                  2 |                3 |    61609977 | SELECT roles.id, roles.agency_id, roles.name                                                                                                                                                                                                                                                                                                                                                                    +
       |            |             |           |               |                    |                  |             |         FROM roles                                                                                                                                                                                                                                                                                                                                                                                              +
       |            |             |           |               |                    |                  |             |           INNER JOIN roles_users ON roles_users.role_id = roles.id                                                                                                                                                                                                                                                                                                                                              +
       |            |             |           |               |                    |                  |             |         WHERE roles_users.user_id = $1                                                                                                                                                                                                                                                                                                                                                                          +
       |            |             |           |               |                    |                  |             |         ORDER BY name
 16563 |          8 |       0.008 |    349207 |          2956 |                  6 |                4 |     3736356 | SELECT "roles".* FROM "roles" INNER JOIN "roles_users" ON "roles"."id" = "roles_users"."role_id" WHERE ($2=$3) AND "roles_users"."user_id" = $1
 16563 |          9 |       0.002 |     10092 |            16 |                 11 |               10 |        8007 | SELECT "role_grants".* FROM "role_grants" INNER JOIN "roles" ON "role_grants"."role_id" = "roles"."id" INNER JOIN "roles_users" ON "roles"."id" = "roles_users"."role_id" WHERE "role_grants"."agency_id" = $1 AND "roles"."agency_id" = $2 AND "roles_users"."user_id" = $3 AND (roles.agency_id IN ($4)) AND "role_grants"."category" = $5
 16563 |         10 |       0.008 |      3529 |            28 |                 10 |                5 |        5640 | SELECT "roles"."name" FROM "roles" INNER JOIN "roles_users" ON "roles"."id" = "roles_users"."role_id" WHERE ($1=$2) AND "roles_users"."user_id" = $3 AND ($4 = $5)
 16563 |         10 |       0.002 |      3529 |             7 |                 13 |                9 |      802944 | SELECT "role_grants".* FROM "role_grants" INNER JOIN "roles" ON "role_grants"."role_id" = "roles"."id" INNER JOIN "roles_users" ON "roles"."id" = "roles_users"."role_id" WHERE ($1=$2) AND ($3=$4) AND "roles_users"."user_id" = $5 AND ($6 = $7)
 16563 |         12 |       0.000 |      3488 |             1 |                 15 |               17 |        7339 | SELECT "roles"."name" FROM "roles" INNER JOIN "roles_users" ON "roles"."id" = "roles_users"."role_id" WHERE "roles"."agency_id" = $1 AND "roles_users"."user_id" = $2 AND (roles.agency_id IN ($3)) AND (roles.agency_id = $4)
 16563 |         13 |       0.017 |      2267 |            39 |                  9 |                1 |       14144 | SELECT  DISTINCT "users".* FROM "users" INNER JOIN "roles_users" ON "roles_users"."user_id" = "users"."id" INNER JOIN "roles" ON "roles"."id" = "roles_users"."role_id" AND (roles.agency_id IN ($1)) AND "roles"."agency_id" = $2 INNER JOIN user_credentials ON user_credentials.user_id=users.id AND user_credentials.agency_id IN ($3) WHERE ((users.deleted_at IS NULL OR users.deleted_at AT TIME ZONE $4 
 16563 |         14 |       0.007 |      1751 |            12 |                 12 |                7 |       67960 | SELECT DISTINCT "users".* FROM "users" INNER JOIN "roles_users" ON "users"."id" = "roles_users"."user_id" INNER JOIN user_credentials ON user_credentials.user_id=users.id AND user_credentials.agency_id IN ($1) WHERE "roles_users"."role_id" = $2 AND ((users.deleted_at IS NULL OR users.deleted_at AT TIME ZONE $3 > CURRENT_TIMESTAMP) AND (user_credentials.deleted_at IS NULL OR user_credentials.delete
 16563 |         15 |       0.001 |      1302 |             1 |                 14 |               12 |        3733 | SELECT "roles".* FROM "roles" INNER JOIN "roles_users" ON "roles"."id" = "roles_users"."role_id" WHERE "roles"."agency_id" IN ($1, $2) AND "roles_users"."user_id" = $3 AND (roles.agency_id IN ($4,$5))
 16563 |         16 |       0.008 |        47 |             0 |                 16 |                6 |         134 | SELECT "role_grants".* FROM "role_grants" INNER JOIN "roles" ON "role_grants"."role_id" = "roles"."id" INNER JOIN "roles_users" ON "roles"."id" = "roles_users"."role_id" WHERE "role_grants"."agency_id" IN ($1, $2) AND "roles"."agency_id" IN ($3, $4) AND "roles_users"."user_id" = $5 AND (roles.agency_id IN ($6,$7)) AND "role_grants"."category" = $8
 16563 |         17 |       0.001 |        33 |             0 |                 18 |               11 |          35 | SELECT DISTINCT "users".* FROM "users" INNER JOIN "roles_users" ON "roles_users"."user_id" = "users"."id" INNER JOIN "roles" ON "roles"."id" = "roles_users"."role_id" AND (roles.agency_id IN ($1)) AND "roles"."agency_id" = $2 INNER JOIN user_credentials ON user_credentials.user_id=users.id AND user_credentials.agency_id IN ($3) WHERE ((users.deleted_at IS NULL OR users.deleted_at AT TIME ZONE $4 >
 16563 |         18 |       0.011 |         9 |             0 |                 17 |                2 |           9 | SELECT  DISTINCT "users".* FROM "users" INNER JOIN "roles_users" ON "roles_users"."user_id" = "users"."id" INNER JOIN "roles" ON "roles"."id" = "roles_users"."role_id" AND (roles.agency_id IN ($1)) AND "roles"."agency_id" = $2 INNER JOIN user_credentials ON user_credentials.user_id=users.id AND user_credentials.agency_id IN ($3) WHERE (roles.agency_id = $4 AND roles.id IN ($5)) AND ((users.deleted
(18 rows)

